## Домашнее задание к занятию «Введение в виртуализацию» FOPS-38 Щербатых А.Е.

Это задание для самостоятельной отработки навыков и не предполагает обратной связи от преподавателя. Его выполнение не влияет на завершение модуля. Но мы рекомендуем его выполнить, чтобы закрепить полученные знания. Все вопросы, возникающие в процессе выполнения заданий, пишите в раздел "Вопросы по заданиям" в личном кабинете.

**Цели задания** 

Научиться запускать виртуальную машину в Yandex Cloud с минимальным расходом ресурсов.
Попрактиковаться в выборе платформы и системы управления виртуализации для решения требуемых задач.
Инструкция к выполению
Для выполнения задачи 1 ознакомьтесь с инструкцией по экономии облачных ресурсов и затем выполните задачу 1 по шагам.
Своё решение к задачам 2,3,4 загрузите в ваш ЛК.

### Задача 1

Ознакомьтесь с инструкцией по экономии облачных ресурсов.

1. Создайте через web-интерфейс Yandex Cloud - VPC и виртуальную машину из инструкции конфигурации "эконом-ВМ" с публичным ip-адресом. В пункте "Выбор образа/загрузочного диска" выберите вкладку "Cloud Marketplace" , щелкните "Посмотреть больше", найдите образ "Yandex Cloud Toolbox".
2. Убедитесь, что вы можете подключиться к консоли ВМ через ssh, используя публичный ip-адрес. Убедитесь, что на ВМ установлен Docker с помощью команды docker --version(команду выполните от имени root пользователя) !
3. Узнайте в инструкции Яндекс, какие еще инструменты предустановлены в данном образе.
4. Оставьте ВМ работать, пока она не выключится самостоятельно! Опция "прерываемая" выключит ее не позже чем через 24 часа. Для наглядности подождите еще 1 сутки.
5. Перейдите по ссылке . Выберите свой платежный аккаунт. Перейдите на вкладку детализация (фильтр "По продуктам") и оцените график потребления финансов.
6. Удалите ВМ или пользуйтесь ею при выполнении последующих домашних заданий курса обучения.

### Задача 2

Выберите один из вариантов платформы в зависимости от задачи. Здесь нет однозначно верного ответа так как все зависит от конкретных условий: финансирование, компетенции специалистов, удобство использования, надежность, требования ИБ и законодательства, фазы луны.

Тип платформы:

- физические сервера;
- паравиртуализация;
- виртуализация уровня ОС;
  
Задачи:

- высоконагруженная база данных MySql, критичная к отказу;
- различные web-приложения;
- Windows-системы для использования бухгалтерским отделом;
- системы, выполняющие высокопроизводительные расчёты на GPU.
  
Объясните критерии выбора платформы в каждом случае.

### Задача 3

Выберите подходящую систему управления виртуализацией для предложенного сценария. Опишите ваш выбор.

Сценарии:

1. 100 виртуальных машин на базе Linux и Windows, общие задачи, нет особых требований. Преимущественно Windows based-инфраструктура, требуется реализация программных балансировщиков нагрузки, репликации данных и автоматизированного механизма создания резервных копий.
2. Требуется наиболее производительное бесплатное open source-решение для виртуализации небольшой (20-30 серверов) инфраструктуры на базе Linux и Windows виртуальных машин.
3. Необходимо бесплатное, максимально совместимое и производительное решение для виртуализации Windows-инфраструктуры.
4. Необходимо рабочее окружение для тестирования программного продукта на нескольких дистрибутивах Linux.

### Задача 4

Опишите возможные проблемы и недостатки гетерогенной среды виртуализации (использования нескольких систем управления виртуализацией одновременно) и что необходимо сделать для минимизации этих рисков и проблем. Если бы у вас был выбор, создавали бы вы гетерогенную среду или нет?

**Правила приема**
Домашнее задание выполните в файле readme.md в GitHub-репозитории. В личном кабинете отправьте на проверку ссылку на .md-файл в вашем репозитории.

### Решение

#### Задание 1



#### Задание 2

Таблица с рекомендуемыми платформами и основными аргументами для каждого сценария:

| Задача | Рекомендуемая платформа | Ключевые критерии выбора | Альтернативы и нюансы |
| :--- | :--- | :--- | :--- |
| **Высоконагруженная БД MySQL** | **Физические сервера** (Bare Metal) | **Производительность** (минимальные задержки I/O), **надежность** (полный контроль над железом), **предсказуемость**. | **Паравиртуализация** (VMware, KVM) с PCIe Passthrough для дисков — если критична **масштабируемость/миграция**. |
| **Различные web-приложения** | **Виртуализация уровня ОС** (Docker + Kubernetes) | **Плотность** и **эффективность**, **скорость развертывания**, **переносимость**, **микросервисная архитектура**. | **Паравиртуализация** — для **монолитных** приложений или при отсутствии экспертизы по контейнерам. |
| **Windows для бухгалтерии** | **Паравиртуализация** (VMware, Hyper-V) | **Изоляция** и **безопасность**, **управляемость** (снапшоты, бэкапы), **совместимость** с лицензированием Windows. | Для **высокопроизводительных** рабочих станций — **VDI** на базе паравиртуализации. |
| **Высокопроизводительные расчёты на GPU** | **Физические сервера** или **специализированные облака** (AWS EC2 P3, GCP A2) | **Прямой доступ к железу** (особенно GPU, NVLink), **производительность сети** (InfiniBand), **стоимость** при постоянной загрузке. | **Паравиртуализация** с **GPU Passthrough/SR-IOV** — для разделения дорогой карты между несколькими задачами. |

#### Обоснование по каждому случаю

#### 1. Высоконагруженная база данных MySQL, критичная к отказу
*   **Ключевые критерии**: Производительность дискового ввода-вывода (I/O) и оперативной памяти, минимальная задержка (latency), полный контроль над ресурсами.
*   **Почему физические сервера**: Гипервизор добавляет overhead (накладные расходы) на доступ к дискам и памяти, что для высоких нагрузок критично. Прямой доступ к NVMe-дискам и настройка RAID-контроллера дают максимальную скорость и предсказуемость. Для отказоустойчивости строится кластер поверх физических серверов (например, на основе репликации MySQL Galera или Percona XtraDB Cluster).
*   **Альтернатива**: Если требования к масштабируемости и миграции выше, чем к предельной производительности, можно использовать **паравиртуализацию**. Но тогда для СУБД нужно выделять отдельные физические диски с технологией PCIe Passthrough (сквозной доступ), чтобы виртуальная машина работала с ними напрямую, минуя виртуальное хранилище гипервизора.

#### 2. Различные web-приложения
*   **Ключевые критерии**: Эффективность использования ресурсов, скорость развертывания и масштабирования, изоляция зависимостей, простое управление множеством сред (dev, test, prod).
*   **Почему виртуализация уровня ОС (контейнеры)**: Контейнеры (Docker) обеспечивают легковесную изоляцию, запускаясь в долю секунды и потребляя минимум ресурсов по сравнению с полноценной виртуальной машиной. Оркестратор (Kubernetes) решает задачи масштабирования, балансировки нагрузки и отказоустойчивости идеально для stateless (без сохранения состояния) веб-приложений. Это стандарт де-факто для микросервисной архитектуры.
*   **Альтернатива**: Для **монолитных** или **legacy-приложений**, которые сложно или не нужно контейнеризировать, лучше подойдет классическая **паравиртуализация**. Она дает полную изоляцию и привычную модель управления.

#### 3. Windows-системы для бухгалтерского отдела
*   **Ключевые критерии**: Надёжная изоляция (одна сбойная система не должна влиять на другие), простота резервного копирования и восстановления, совместимость с лицензированием Microsoft, централизованное управление.
*   **Почему паравиртуализация**: Полноценные виртуальные машины с Windows — это стандартный и хорошо управляемый подход. Гипервизор (особенно **Hyper-V** от Microsoft) обеспечивает отличную интеграцию, поддержку снапшотов для быстрого отката, лёгкое перемещение ВМ между хостами (Live Migration). Это соответствует корпоративным стандартам и лицензионным соглашениям Microsoft.
*   **Альтернатива**: Для задач, требующих графического интерфейса высокой чёткости (например, работа с 1С), может использоваться технология **VDI (Virtual Desktop Infrastructure)** — по сути, те же виртуальные машины, но с оптимизированной передачей графики на тонкие клиенты.

#### 4. Системы для высокопроизводительных расчётов на GPU
*   **Ключевые критерии**: **Максимальная и эксклюзивная производительность** GPU, минимальные задержки при доступе к видеопамяти и между GPU (через NVLink), высочайшая скорость сети (InfiniBand).
*   **Почему физические сервера (или специализированный облачный инстанс)**: Любая виртуализация вносит задержки при доступе к GPU, что сводит на нет преимущества дорогого оборудования для задач ML, рендеринга или вычислений. Прямой доступ (Bare Metal) гарантирует, что вся мощь карты (наподобие NVIDIA A100/H100) используется на 100%. При постоянной загрузке собственные сервера часто выгоднее облачных.
*   **Альтернатива**: Если нужно **разделить** одну мощную GPU между несколькими менее требовательными задачами или пользователями, используют **паравиртуализацию с технологией GPU Passthrough** (сквозной доступ) или **SR-IOV** (создание виртуальных функций GPU). Это сложнее в настройке, но повышает утилизацию дорогого оборудования.

#### Задание 3

Моё предложение по выбору систем управления виртуализацией, составленные в сравнительную таблицу для наглядности:

| № | Сценарий | Рекомендуемое решение | Почему этот выбор? | Ключевые аргументы |
|:---|:---|:---|:---|:---|
| 1 | **100 ВМ (Windows/Linux)** с требованиями к балансировке, репликации, бэкапам | **VMware vSphere** (ESXi + vCenter) | Полноценное enterprise-решение | Глубокая интеграция с Windows, vMotion, DRS, HA, Site Recovery Manager, поддержка Veeam для бэкапов |
| 2 | **20-30 ВМ**, open source, производительность | **Proxmox VE** | Лучший баланс функциональности и производительности | KVM + LXC, встроенный бэкап, кластеризация "из коробки", ZFS поддержка |
| 3 | **Windows-инфраструктура**, бесплатное, совместимое | **Microsoft Hyper-V Server** (бесплатная версия) | Нативная поддержка от Microsoft | Идеальная интеграция с Windows Update, AD, SMB, высокая производительность гостевых Windows |
| 4 | **Тестовое Linux-окружение** | **Vagrant** + **libvirt**/**VirtualBox** | Идеально для разработки и тестирования | Декларативная настройка через код, воспроизводимость, быстрый запуск/остановка |

#### **Сценарий 1: 100 ВМ, Windows-инфраструктура, требования к HA и бэкапам**
**Выбор: VMware vSphere (ESXi + vCenter Server)**

Это классический корпоративный сценарий, где приоритеты — **надёжность**, **централизованное управление** и **готовые встроенные механизмы** для отказоустойчивости.

*   **Для Windows**: vSphere обеспечивает наилучшую интеграцию с Windows Server через VMware Tools, включая корректную работу с обновлениями и службами каталогов. Многие корпоративные инструменты для Windows (как тот же Veeam Backup & Replication) изначально "заточены" под vSphere.
*   **Программные балансировщики и репликация**: Встроенные механизмы **vSphere Distributed Resource Scheduler (DRS)** автоматически балансируют нагрузку между физическими хостами. **vSphere High Availability (HA)** автоматически перезапускает упавшие ВМ на других хостах. Для репликации между дата-центрами есть **vSphere Site Recovery Manager (SRM)**. Это "золотой стандарт", который снимает множество инженерных задач.
*   **Резервное копирование**: Экосистема vSphere имеет максимальную поддержку среди профессиональных СУБД, включая **Veeam Backup & Replication**, которая считается лучшей в своем классе для виртуальных сред.

**Альтернатива**: **Microsoft Hyper-V** с **System Center Virtual Machine Manager (SCVMM)**. Это сильный конкурент в чисто Windows-среде, но зачастую vSphere предлагает более зрелую и отполированную экосистему для смешанных нагрузок.

#### **Сценарий 2: 20-30 ВМ, бесплатное open source, производительность**
**Выбор: Proxmox Virtual Environment**

Здесь ключевые критерии — **бесплатность**, **открытый исходный код** и **высокая производительность** (особенно для KVM).

*   **Производительность**: Proxmox использует проверенный гипервизор **KVM (Kernel-based Virtual Machine)**, который в benchmarks часто показывает результаты, близкие к "железу" (bare-metal), особенно для Linux-гостей.
*   **Полнота решения**: Это не просто гипервизор, а **готовая платформа для управления** с веб-интерфейсом. Из коробки дает кластеризацию, программное определение хранилищ (Ceph/LVM/ZFS), встроенный механизм бэкапов и удобный централизованный мониторинг.
*   **Open Source**: Полная прозрачность кода и свобода от лицензионных отчислений.
*   **Поддержка Linux и Windows**: Отлично работает с Linux, для Windows предоставляет специальные драйверы VirtIO для максимальной производительности дисков и сети.

**Альтернатива**: **oVirt/RHEV**. Это тоже мощная open source-платформа на базе KVM, но она существенно сложнее в первоначальной настройке и больше заточена под очень крупные инсталляции, чем Proxmox.


#### **Сценарий 3: Бесплатная виртуализация Windows-инфраструктуры**
**Выбор: Microsoft Hyper-V Server (бесплатная версия)**

Это **самый логичный и технически обоснованный выбор**. Когда основная задача — запускать гостевые Windows, лучшая платформа — та, что создана тем же вендором.

*   **Максимальная совместимость и производительность**: Hyper-V обеспечивает **нативную, "родную" виртуализацию** для Windows. Гостевые ОС получают прямой доступ к аппаратным ресурсам через **Enlightened I/O** (специальные драйверы). Это дает минимальные накладные расходы, корректную работу всех служб (Active Directory, Exchange и т.д.) и гарантированную поддержку от Microsoft.
*   **Бесплатность**: **Microsoft Hyper-V Server** — это бесплатный, отдельно скачиваемый продукт. Это полноценный гипервизор, не имеющий ограничений по времени или функциональности (в отличие от бесплатной версии ESXi, у которой ограничена функциональность vCenter).
*   **Интеграция в экосистему**: Идеально работает с другими продуктами Microsoft: обновления через WSUS, аутентификация через Active Directory, файловые шары на SMB.

**Важный нюанс**: Бесплатный Hyper-V Server не имеет графического интерфейса управления (только CLI и PowerShell). Для централизованного управления несколькими хостами потребуется либо отдельный платный **Windows Server с ролью Hyper-V и SCVMM**, либо использование бесплатных инструментов вроде **Windows Admin Center** или PowerShell Remoting.

#### **Сценарий 4: Тестовое окружение для Linux-дистрибутивов**
**Выбор: Vagrant + libvirt (или VirtualBox)**

Здесь задача стоит не в постоянной работе виртуальных машин, а в **быстром, воспроизводимом и программируемом** развертывании тестовых сред. Это задача для инструментов **IaC (Infrastructure as Code)**.

*   **Vagrant** — это инструмент для создания и настройки переносимых виртуальных сред. Он позволяет описывать конфигурацию виртуальной машины (ОС, CPU, RAM, установленные пакеты, примененные скрипты) в текстовом файле `Vagrantfile`.
*   **Как это работает**: Вы пишете один `Vagrantfile` для тестового стенда, включающий несколько ВМ (например, Ubuntu, CentOS, Debian). По команде `vagrant up` все они разворачиваются автоматически. По команде `vagrant destroy` — полностью и гарантированно удаляются. Это обеспечивает **идеальную чистоту и повторяемость** тестов.
*   **Провайдеры**: Vagrant может работать поверх различных гипервизоров (провайдеров). Для максимальной производительности в Linux-среде лучше использовать провайдер **libvirt/KVM**. Для максимальной простоты и кроссплатформенности подойдет **VirtualBox**.
*   **Эффективность**: Механизм **provisioning** в Vagrant (Ansible, Shell, Puppet) позволяет автоматически настраивать ВМ после создания, что идеально для подготовки тестового окружения под конкретный продукт.

Использовать полноценную систему виртуализации (вроде тех же vSphere или Proxmox) для этой задачи было бы избыточно и менее гибко.


