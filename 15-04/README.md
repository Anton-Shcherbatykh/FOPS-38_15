## Домашнее задание к занятию 4 «Оркестрация группой Docker контейнеров на примере Docker Compose»

### Задача 1

Сценарий выполнения задачи:

- Установите docker и docker compose plugin на свою linux рабочую станцию или ВМ.
- Если dockerhub недоступен создайте файл /etc/docker/daemon.json с содержимым: {"registry-mirrors": ["https://mirror.gcr.io", "https://daocloud.io", "https://c.163.com/", "https://registry.docker-cn.com"]}
- Зарегистрируйтесь и создайте публичный репозиторий с именем "custom-nginx" на https://hub.docker.com (ТОЛЬКО ЕСЛИ У ВАС ЕСТЬ ДОСТУП);
- скачайте образ nginx:1.29.0;
- Создайте Dockerfile и реализуйте в нем замену дефолтной индекс-страницы(/usr/share/nginx/html/index.html), на файл index.html с содержимым:

```bash
<html>
<head>
Hey, Netology
</head>
<body>
<h1>I will be DevOps Engineer!</h1>
</body>
</html>
```

- Соберите и отправьте созданный образ в свой dockerhub-репозитории c tag 1.0.0 (ТОЛЬКО ЕСЛИ ЕСТЬ ДОСТУП).
- Предоставьте ответ в виде ссылки на https://hub.docker.com/<username_repo>/custom-nginx/general .

### Решение 1.

Установил docker и docker compose

![alt text](Pictures/pic01.jpg)

- Скачал образ nginx:1.29.0.
- Создал ```index.html``` c содержимым из задания.
- Создал ```dockerfile``` в котором реализовал замену дефолтной стартовой страницы на созданную.

![alt text](Pictures/pic04.jpg)

- Собрал и отправил созданный образ в свой dockerhub-репозиторий c tag 1.0.0

![alt text](Pictures/pic02.jpg)

![alt text](Pictures/pic03.jpg)

[Ссылка на репозиторий](https://hub.docker.com/repository/docker/anton13th/custom-nginx/general)

---

### Задача 2

Запустите ваш образ custom-nginx:1.0.0 командой docker run в соответвии с требованиями:
- имя контейнера "ФИО-custom-nginx-t2"
- контейнер работает в фоне
- контейнер опубликован на порту хост системы 127.0.0.1:8080
  
Не удаляя, переименуйте контейнер в "custom-nginx-t2"

Выполните команду date +"%d-%m-%Y %T.%N %Z" ; sleep 0.150 ; docker ps ; ss -tlpn | grep 127.0.0.1:8080  ; docker logs custom-nginx-t2 -n1 ; docker exec -it custom-nginx-t2 base64 /usr/share/nginx/html/index.html

Убедитесь с помощью curl или веб браузера, что индекс-страница доступна.

В качестве ответа приложите скриншоты консоли, где видно все введенные команды и их вывод.


### Решение 2.

Запустил образ с соблюдением требований в задании

![alt text](Pictures/pic05.jpg)

Проверим через браузер

![alt text](Pictures/pic05_1.jpg)

Выполнил команду из задания 

```date +"%d-%m-%Y %T.%N %Z" ; sleep 0.150 ; docker ps ; ss -tlpn | grep 127.0.0.1:8080  ; docker logs custom-nginx-t2 -n1 ; docker exec -it custom-nginx-t2 base64 /usr/share/nginx/html/index.html```

Результат выполнения команды

![alt text](Pictures/pic06.jpg)

Проверяем доступность индекс-страницы через браузер

![alt text](Pictures/pic07.jpg)

и через ```curl```

![alt text](Pictures/pic08.jpg)

---

### Задача 3

1. Воспользуйтесь docker help или google, чтобы узнать как подключиться к стандартному потоку ввода/вывода/ошибок контейнера "custom-nginx-t2".
2. Подключитесь к контейнеру и нажмите комбинацию Ctrl-C.
3. Выполните docker ps -a и объясните своими словами почему контейнер остановился.
4. Перезапустите контейнер
5. Зайдите в интерактивный терминал контейнера "custom-nginx-t2" с оболочкой bash.
6. Установите любимый текстовый редактор(vim, nano итд) с помощью apt-get.
7. Отредактируйте файл "/etc/nginx/conf.d/default.conf", заменив порт "listen 80" на "listen 81".
8. Запомните(!) и выполните команду nginx -s reload, а затем внутри контейнера curl http://127.0.0.1:80 ; curl http://127.0.0.1:81.
9. Выйдите из контейнера, набрав в консоли exit или Ctrl-D.
10. Проверьте вывод команд: ss -tlpn | grep 127.0.0.1:8080 , docker port custom-nginx-t2, curl http://127.0.0.1:8080. Кратко объясните суть возникшей проблемы.
11. - Это дополнительное, необязательное задание. Попробуйте самостоятельно исправить конфигурацию контейнера, используя доступные источники в интернете. Не изменяйте конфигурацию nginx и не удаляйте контейнер. Останавливать контейнер можно. пример источника
12. Удалите запущенный контейнер "custom-nginx-t2", не останавливая его.(воспользуйтесь --help или google)

В качестве ответа приложите скриншоты консоли, где видно все введенные команды и их вывод.


### Решение 3.

1. Подключился к стандартному потоку ввода/вывода/ошибок контейнера "custom-nginx-t2" (команда ```docker attach```)
2. Прервал выполнение комбинацией клавиш **Ctrl-C**
3. Выполнил ```docker ps -a```

![alt text](Pictures/pic09.jpg)

**Объяснение:** Контейнер остановился, потому что nginx завершил работу. Когда я подключлся через ```docker attach```, я подключился к процессу **nginx**, а команда **Ctrl+C** отправила сигнал ```SIGINT``` (прерывание) этому процессу. Nginx получил сигнал остановки и завершил работу, что привело к остановке контейнера, так как процесс с **PID=1 (nginx)** завершился.

4. Перезапустил контейнер

![alt text](Pictures/pic010.jpg)

5. Зашёл в интерактивный терминал контейнера "custom-nginx-t2" с оболочкой ```bash```
6. Установил текстовый редактор **nano**

![alt text](Pictures/pic011.jpg)

7. Отредактировал файл "/etc/nginx/conf.d/default.conf", заменив порт "listen 80" на "listen 81"
8. Выполнил команду ```nginx -s reload```,
   - а затем внутри контейнера ```curl http://127.0.0.1:80```
   - затем  ```curl http://127.0.0.1:81```
9. И вышел из консоли с помощью команды ```exit```
  
   ![alt text](Pictures/pic012.jpg)

10. Проверил вывод команд:
    - ```ss -tlpn | grep 127.0.0.1:8080```
    - ```docker port custom-nginx-t2```
    - ```curl http://127.0.0.1:8080.```

![alt text](Pictures/pic013.jpg)

#### Объяснение проблемы

- Внутри контейнера я изменил порт прослушивания nginx с 80 на 81
- Снаружи контейнера проброс портов настроен как 127.0.0.1:8080 → 80 (контейнер)
- Контейнер пробрасывает хост-порт 8080 на контейнерный порт 80. Но внутри контейнера nginx теперь слушает на порту 81. Получается разрыв связи: запросы с хоста на 127.0.0.1:8080 перенаправляются на порт 80 контейнера, но там ничего не слушает.
- Результат: curl http://127.0.0.1:8080 возвращает ошибку соединения.
  

11. Docker не позволяет напрямую изменять проброс портов у запущенного контейнера, но можно создать новый контейнер из существующего с новыми параметрами.

- Останавливаем контейнер ```docker stop custom-nginx-t2```
- Сохраняем текущее состояние контейнера в новый образ ```docker commit custom-nginx-t2 custom-nginx-port-81```
- Запускаем новый контейнер с правильным пробросом портов ```docker run -d --name custom-nginx-t2-fixed -p 127.0.0.1:8080:81 custom-nginx-port-81```

![alt text](Pictures/pic014.jpg)
  
- Пробую переименовать новый контейнер ```docker rename custom-nginx-t2-fixed custom-nginx-t2``` . **НЕУДАЧНО.** При существующем контейнере **custom-nginx-t2** переименовать не получилось. Оставляю первый "старый" контейнер в остановленном состоянии, работаю с "новым". Делаю вывод, что в Docker нельзя иметь два контейнера с одинаковым именем, даже если один из них остановлен. Нужно сначала освободить имя.
- Проверяю работу нового контейнера ```docker exec custom-nginx-t2-fixed curl -s http://127.0.0.1:81```

![alt text](Pictures/pic015.jpg)

12. Удаляю запущенный контейнер "custom-nginx-t2", не останавливая его. Это возмоэжно выполнить с помощью команды ```docker rm -f custom-nginx-t2``` (с флагом ```-f``` (force)).

Проверяю, что контейнер удалён ```docker ps -a | grep custom-nginx-t2```

![alt text](Pictures/pic016.jpg)

---


